language: node_js
node_js:
- node
cache: npm
install:
- npm install newman
stages:
- name: build_deploy
  if: "(branch = dev)"
- name: release
  if: "(branch = main)"
- name: code_analysis
  if: "(branch = ca)"
- name: build
  if: "(branch != dev AND branch != main AND branch != ca)"
jobs:
  include:
  - stage: build_deploy
    name: Dev deployment
    script:
    - cd frontend/booken
    - npm install
    - npm run build
    before_deploy:
    - cd ../../backend/flask-api
    on:
      repo: UB-ES-2020-A/Booken
    branches:
      only:
      - dev
    deploy:
      provider: heroku
      api_key:
        secure: SMDM3hNlDdRBY8zVYeFE2W0yPbl4M5b3TkmRkXT35uNrxwB806z2/Pynx0GUJb4OZXenCgavItd42yDFViPouIg3WqqTvmCqSCFUcnCxTcd0XTKQ4lC5PR1tfEiraGaEm2l2R2BBmDoWwxk4tIhmCiGIKclnlsdHlKHn1ubrU0jl+ESwuJ3W/dHbLxk9YcP9Z4CLD1NwJjJArlt3sRpYkL2UtYaGKFRt9pni59jHOzvp1Bc0gUeVIIB6TdzUWtfzjDXV53gDQ9ttNWXzgUQ56xhIL7qzOJKHtGRRwSOiz9BwgQl1aj2h1HjkBtDYlvVyP/7+Xqy5ZksqP1t4CfKEnZvVOcF5ZY4Pgu3OBes/9rfvNMjEijVpMz1R7pJt6KJyXe9ZPXMGIDA+Y3Kavx5Nmany6p3wHSGfAbveyq+ldbo6pTgcmmjCu3z7cbPAx1unjCKEBe5R4q/kTbNpgMAstfkvxoireFCybI0+AWhYA3v8+D8JK2c+MY4cYs8rBUXkJMAAozNymlHnMSnM7T2zdqRsXdNQ7W29JpumnSakxEHv839dPxrjqyhCDx+Ucp7Tba8vL6QZcTnqQASqhlVxeWhTtXoLiKuUEqK4vezUC9nazeDGMiHvccCa16M/8zxRf0eho1hgzSvzNb7BK/6GyPADkHcKToDwbO67E+5yj8k=
      app:
        dev: booken-dev
      after_deploy:
      - cd ../..
      - node_modules/.bin/newman run backend/tests/TEST----Account-Login.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Author.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Book.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Reviews.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Address.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Card.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Orders.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Articles.postman_collection.json
  - stage: release
    name: Production deployment
    script:
    - cd frontend/booken
    - npm install
    - npm run build
    before_deploy:
    - cd ../../backend/flask-api
    on:
      repo: UB-ES-2020-A/Booken
    branches:
      only:
      - main
    deploy:
      provider: heroku
      api_key:
        secure: SMDM3hNlDdRBY8zVYeFE2W0yPbl4M5b3TkmRkXT35uNrxwB806z2/Pynx0GUJb4OZXenCgavItd42yDFViPouIg3WqqTvmCqSCFUcnCxTcd0XTKQ4lC5PR1tfEiraGaEm2l2R2BBmDoWwxk4tIhmCiGIKclnlsdHlKHn1ubrU0jl+ESwuJ3W/dHbLxk9YcP9Z4CLD1NwJjJArlt3sRpYkL2UtYaGKFRt9pni59jHOzvp1Bc0gUeVIIB6TdzUWtfzjDXV53gDQ9ttNWXzgUQ56xhIL7qzOJKHtGRRwSOiz9BwgQl1aj2h1HjkBtDYlvVyP/7+Xqy5ZksqP1t4CfKEnZvVOcF5ZY4Pgu3OBes/9rfvNMjEijVpMz1R7pJt6KJyXe9ZPXMGIDA+Y3Kavx5Nmany6p3wHSGfAbveyq+ldbo6pTgcmmjCu3z7cbPAx1unjCKEBe5R4q/kTbNpgMAstfkvxoireFCybI0+AWhYA3v8+D8JK2c+MY4cYs8rBUXkJMAAozNymlHnMSnM7T2zdqRsXdNQ7W29JpumnSakxEHv839dPxrjqyhCDx+Ucp7Tba8vL6QZcTnqQASqhlVxeWhTtXoLiKuUEqK4vezUC9nazeDGMiHvccCa16M/8zxRf0eho1hgzSvzNb7BK/6GyPADkHcKToDwbO67E+5yj8k=
      app:
        dev: booken-app
      after_deploy:
      - cd ../..
      - node_modules/.bin/newman run backend/tests/TEST----Account-Login.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Author.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Book.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Reviews.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Address.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Card.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Orders.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Articles.postman_collection.json
  - stage: code_analysis
    name: Code Analysis SCA/DCA/CC
    script:
    - cd ../../backend/flask-api
    after_success:
    - coveralls
  - stage: build
    name: Project build
    script:
    - cd frontend/booken
    - npm install
    - npm run build
notifications:
  slack:
    secure: f34BdFt+KsevoHYG6jeS3AXe+y1K2cOnt96ZO+Rt2pxjTv+ugZW/FmAZb9ukTxUqdhMxWyybxS8U1wVuadXd2bn6LpVV9j9K9VNPATatHJ+b0Obwh+ctc4uzmLpBPvX/K4v2tSOTfBVjBL8sLXYvhVmvQ/aQqUjayklFxAqfDQSIjw/WovK2xFwRXwmxVFjT+NPlWEu2Mnqer+3IvJis2bg8/hQ2sRGBew2hvtW3oRCoHvV3qYAHe1M+3+BZ1gTQst31Xi9w1Y/PmIuP92rjqeKQfV2CQQ383wWGezX7onj/x+vC7xv9Lq5R4DV/gnJQLkafDcemEVGtp+4PAgpTxIEIJzUvU5yGm+1tV5S80HD2Q2xHHw/57RM7I7E3HEu1/wJgeWbB/vk6dmaKLdY/+tbppNh8FSughJIK6j3wkgj6m0IiKbjzCG7mV+geZe3wN7DBLqgCJLmc0C5bKLg87QfWJUCFDDahthNKIfgCywnXmq7yRPKKtQVQLYTiGbhOudpD83EsjF4qxWEbBeeEpsYEbtiCpW92LM4s0HtPR1y5vyssixGmdkSGIjII+Z2vIcsz8Sjsaw2c6tXKJ53guqGNSrN6Vt2NpVQTUhmSuI/Vggb17Ekw+G58c7DpnNOfvn5mP8wTH2/oPveth5FrKUIncJw9kWag6MnnhlcywG8=
