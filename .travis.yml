language: node_js
node_js:
- node
cache: npm
install:
- npm install newman
stages:
- name: build_deploy
  if: "(branch = dev)"
- name: release
  if: "(branch = main)"
- name: code_analysis
  if: "(branch = ca)"
- name: build
  if: "(branch != dev AND branch != main AND branch != ca)"
jobs:
  include:
  - stage: build_deploy
    name: Dev deployment
    script:
    - cd frontend/booken
    - npm install
    - npm run build
    before_deploy:
    - cd ../../backend/flask-api
    on:
      repo: UB-ES-2020-A/Booken
    branches:
      only:
      - dev
    deploy:
      provider: heroku
      api_key:
        secure: QbddOLs5MuHifIKHHIoVWuXQWAc0yoA6c6/HdjSWQXAQw6hxnD+1eSCp7LGDLgSIP+G+I49uczH8/Fc8SaJ90U08huEzfeHXXzUxePtVaA1qgIhTZKmKxiy7zaB7ik8Ax3PAEZuJ7d/XfDFyWbQW+4WvznRFgoUTOKGqtRlOzT7PE73kgiJ84qS0bW6q2ByW7YN3i4RXUko1lcWbqGAjWscuRSzZS7w4dKW9whz1O3d6EneDDqaNDDzpLK6y640LBqsZPX1LsTW91SGIXMOgABn+IFYW6qDyxojDx4N6IglrSD5Ulq0JS5lNdvkxtYlPFE5KoVd/nSHwsjRn5WWKOTu1N1vSEdLVXYQW+bl7opW5bVkCSKxuscu6wljm7ts9i467WC2Aw5e0+plV8iUQv5/2B0YDz8iH6+B5aa1dL02l1AruIBFTv0WjNsbXwbhU8jNTYKmhnhiTkTfPySeX1B4jtGyQ6wkTmThS273MylXX9LiXUw2KPqo4JOqXL0uF2QD8P1K6uOIkIgoZPfpUJFk0lZ77qHnMHfb+ytRQB/UpKlcU1JED/LyQSDjjR+j4FklZKkeVD6SCGoF7ODrFC7PV6vHESs4Y6dhGSwigbD/Wax+tBs6QM20mlPxf4e5xgcdPM91amKWMQ8s1Z6S3X2yUzpNG1BtF2bWbPRW/3+I=
      app:
        dev: booken-dev
      after_deploy:
      - cd ../..
      - node_modules/.bin/newman run backend/tests/TEST----Account-Login.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Author.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Book.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Reviews.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Address.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Card.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Orders.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Articles.postman_collection.json
  - stage: release
    name: Production deployment
    script:
    - cd frontend/booken
    - npm install
    - npm run build
    before_deploy:
    - cd ../../backend/flask-api
    on:
      repo: UB-ES-2020-A/Booken
    branches:
      only:
      - main
    deploy:
      provider: heroku
      api_key:
        secure: QbddOLs5MuHifIKHHIoVWuXQWAc0yoA6c6/HdjSWQXAQw6hxnD+1eSCp7LGDLgSIP+G+I49uczH8/Fc8SaJ90U08huEzfeHXXzUxePtVaA1qgIhTZKmKxiy7zaB7ik8Ax3PAEZuJ7d/XfDFyWbQW+4WvznRFgoUTOKGqtRlOzT7PE73kgiJ84qS0bW6q2ByW7YN3i4RXUko1lcWbqGAjWscuRSzZS7w4dKW9whz1O3d6EneDDqaNDDzpLK6y640LBqsZPX1LsTW91SGIXMOgABn+IFYW6qDyxojDx4N6IglrSD5Ulq0JS5lNdvkxtYlPFE5KoVd/nSHwsjRn5WWKOTu1N1vSEdLVXYQW+bl7opW5bVkCSKxuscu6wljm7ts9i467WC2Aw5e0+plV8iUQv5/2B0YDz8iH6+B5aa1dL02l1AruIBFTv0WjNsbXwbhU8jNTYKmhnhiTkTfPySeX1B4jtGyQ6wkTmThS273MylXX9LiXUw2KPqo4JOqXL0uF2QD8P1K6uOIkIgoZPfpUJFk0lZ77qHnMHfb+ytRQB/UpKlcU1JED/LyQSDjjR+j4FklZKkeVD6SCGoF7ODrFC7PV6vHESs4Y6dhGSwigbD/Wax+tBs6QM20mlPxf4e5xgcdPM91amKWMQ8s1Z6S3X2yUzpNG1BtF2bWbPRW/3+I=
      app:
        dev: booken-app
      after_deploy:
      - cd ../..
      - node_modules/.bin/newman run backend/tests/TEST----Account-Login.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Author.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Book.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Reviews.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Address.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Card.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Orders.postman_collection.json
      - node_modules/.bin/newman run backend/tests/TEST----Articles.postman_collection.json
  - stage: code_analysis
    name: Code Analysis SCA/DCA/CC
    script:
    - cd ../../backend/flask-api
    after_success:
    - coveralls
  - stage: build
    name: Project build
    script:
    - cd frontend/booken
    - npm install
    - npm run build
notifications:
  slack:
    secure: bvbWP5dF+JlOTH8hgeLBXcZxHVht6X7d5j7+W4gWyH0skPi7OaNNvB/+ZV57CWFhdzstQodgDvS9DnCcx59dYbg1rlR3beK7yaoHxRr9TFcvnJ0Blz2hD8wxGTWcW6X6aaztf0QpTICCRkt4qpIQFFR6RH0n36m89JrqVIRzsxuMFsMsfClheEJ4MWW3JSVuMWdy76p0g1J5gG3LPhzM99XaxGtKQd9Fy+Lnybp2wk1IDiiwdAHSBURMemXXH8IqNwHapd+cRheymDWqFiZFOou8VmvOZlTFE/1RXlwPw2YRg5XonyzYOTPddX8nIivTlkFhhq5EEbFUaRa5gHCxKbVTktisfMoyFCW516FniKrNpvt05Qe8a+2udPHxJSmXPPkoyOU1LRxpHW/yEmBty5Y48WoRDvnxpqf8Ns9TnxAygx7ixB0rg7PkXi/1AYo+X40NBoZ0TpAewUEfTSnKRj22YL2V0RAYblb/e1Ib1jl+M2WZ8oUgssgS6OMHeu2flrnW0cax/mofbIv0PDCZieAlPyTsTUav8EEjFJsKoYdeYQJ8Uuf3NQaAx7KE2UfUsr/zROtNyspmCyF4J2bxdYhdhh0Px6IXuS5cjcwCvx79JvWsBwwVvEoR8QFyCwz84+WneNU09PxgCAyWVJyC9KpAOqr7cQWu4anOVUudv3I=
